<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Swarm Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-size: 18px;
            /* increases overall scale */
            font-family: system-ui, sans-serif;
            padding: 1em;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;

            @media (max-width: 700px) {
                html {
                    font-size: 20px;
                    /* bigger default scale for phones */
                }
            }

            h1 {
                text-align: center;
            }

            button {
                margin-left: .5em;
                padding: 0.6em 1em;
                border: none;
                border-radius: 8px;
                background: #ddd;
                cursor: pointer;
                font-size: 1em;
                transition: background 0.2s;
            }

            button:hover {
                background: #ccc;
            }

            .btn-danger {
                background: #e74c3c;
                color: white;
            }

            .btn-danger:hover {
                background: #c0392b;
            }

            .btn-success {
                background: #27ae60;
                color: white;
            }

            .btn-success:hover {
                background: #1e874b;
            }

            .controls {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 0.6em;
                background: #fff;
                padding: 0.8em;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
                margin-bottom: 1em;
                max-width: 600px;
                width: 100%;
            }

            .controls-section {
                display: flex;
                align-items: center;
                gap: 0.5em;
                flex-wrap: wrap;
            }

            #creatureSummary {
                transition: opacity 0.25s ease;
                font-size: 0.95em;
                text-align: center;
                margin-top: -0.4em;
                margin-bottom: 0.8em;
                line-height: 1.2em;
            }

            #creatureSummary:empty {
                opacity: 0;
                height: 0;
                margin: 0;
                overflow: hidden;
            }

            .add-section {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .add-controls {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 0.4em;
                width: 100%;
            }

            .add-controls input[type="number"] {
                width: 4em;
                /* üü¢ Shrunk to fit inside the menu nicely */
                text-align: center;
                padding: 0.4em;
                font-size: 1em;
                border-radius: 6px;
                border: 1px solid #ccc;
            }

            .add-controls button {
                flex: 1 1 45%;
                min-width: 130px;
                text-align: center;
                padding: 0.6em 0.8em;
            }

            .buff-section {
                display: flex;
                justify-content: center;
                width: 100%;
            }

            .buff-controls {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 0.6em;
                width: 100%;
            }

            .buff-controls button {
                flex: 1 1 45%;
                min-width: 130px;
                text-align: center;
                padding: 0.6em 0.8em;
            }


            label {
                margin: 0 .3em;
            }

            .divider {
                width: 2px;
                height: 36px;
                background: #ccc;
            }

            .trigger {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: #fff;
                padding: .5em 1em;
                margin: .3em 0;
                border-radius: 8px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 500px;
            }

            .counter {
                display: flex;
                align-items: center;
                gap: .5em;
            }

            .counter button {
                width: 2.5em;
                height: 2.5em;
            }

            .section-title {
                text-align: center;
                margin-top: 1em;
                margin-bottom: .5em;
                font-weight: bold;
            }

            input[type="number"] {
                width: 5.5em;
                text-align: center;
                padding: .5em;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 1em;
            }

            /* üß≠ Center the Lands block cleanly */
            .land-section {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.6em;
                width: 100%;
                text-align: center;
            }

            .land-label {
                font-weight: bold;
            }

            .land-counter {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.3em;
            }

            .land-counter button {
                width: 2.4em;
                height: 2.4em;
                font-size: 1em;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Grid layout for creatures */
            #list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.6em;
                width: 100%;
                max-width: 500px;
            }

            .item {
                background: #fff;
                padding: .6em;
                border-radius: 10px;
                text-align: center;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .item.scute strong {
                color: #2ecc71;
            }

            .item button {
                margin-top: .25em;
                font-size: 0.95em;
            }

            .creature-stat {
                font-size: 1em;
                color: #444;
            }

            .land-counter {
                display: flex;
                align-items: center;
                gap: 0.3em;
            }

            .land-value {
                font-weight: bold;
                min-width: 2em;
                text-align: center;
                font-size: 1.1em;
            }

            /* Popup styling */
            .popup {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(46, 204, 113, 0.95);
                color: white;
                padding: 0.7em 1.2em;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                font-weight: bold;
                opacity: 1;
                transition: opacity 0.5s ease-out;
                z-index: 1000;
            }

            /* üåê Simplified mobile layout ‚Äî no over-scaling */
            @media (max-width: 700px) {

                html,
                body {
                    font-size: 14px;
                    /* baseline text size */
                }

                h1 {
                    font-size: 1.2em;
                }

                .controls {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 0.6em;
                    max-width: 95%;
                    padding: 0.6em;
                }

                .controls-section {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 0.4em;
                }

                .divider {
                    display: none;
                }

                button {
                    width: 100%;
                    font-size: 0.95em;
                    padding: 0.6em;
                }

                .btn-success,
                .btn-danger {
                    font-size: 1em;
                }

                input[type="number"] {
                    font-size: 0.95em;
                    padding: 0.5em;
                    width: 100%;
                }

                label {
                    font-size: 0.95em;
                }

                .trigger {
                    font-size: 0.95em;
                    padding: 0.5em 0.8em;
                }

                .counter button {
                    width: 2.2em;
                    height: 2.2em;
                    font-size: 0.9em;
                }

                #list {
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                    gap: 0.4em;
                }

                .item {
                    padding: 0.5em;
                }

                .land-counter button {
                    width: 2.2em;
                    height: 2.2em;
                    font-size: 0.9em;
                }

                .land-value {
                    font-size: 1em;
                }

                .popup {
                    font-size: 0.95em;
                    padding: 0.5em 1em;
                }
            }
    </style>




</head>

<body>
    <h1>Swarm Tracker</h1>

    <div class="controls">

        <!-- Landfall button -->
        <div class="controls-section">
            <button class="btn-success" onclick="handleLandfall()">Landfall</button>
        </div>

        <!-- Lands counter -->
        <div class="controls-section land-section">
            <div class="land-label"><strong>Lands</strong></div>
            <div class="land-counter">
                <button onclick="changeLands(-1)">&#8595;</button>
                <span id="landCount" class="land-value">3</span>
                <button onclick="changeLands(1)">&#8593;</button>
            </div>
        </div>

        <!-- Add Scutes / Insects -->
        <div class="controls-section add-section">
            <div class="add-controls">
                <button class="btn-success" onclick="promptAdd('Scute')">Add Scutes</button>
                <button class="btn-success" onclick="promptAdd('Insect')">Add Insects</button>
            </div>
        </div>

        <!-- Remove / Reset -->
        <div class="controls-section buff-section">
            <div class="buff-controls">
                <button class="btn-success" onclick="addCounters()">+1/+1 to all</button>
                <button class="btn-danger" onclick="removeCounters()">-1/-1 to all</button>
            </div>
            <button class="btn-danger" onclick="removeAll()">Remove All</button>
            <button class="btn-danger" onclick="resetAll()">Reset</button>
        </div>
    </div>


    <div class="section-title">Triggers</div>
    <div id="triggers"></div>

    <div class="section-title">Creatures</div>
    <div id="creatureSummary"></div>
    <div id="list"></div>

    <script>
        let values = JSON.parse(localStorage.getItem('values')) || {};
        let lands = parseInt(localStorage.getItem('lands') || '3');
        let triggers = normalizeTriggers(JSON.parse(localStorage.getItem('triggers')));


        function updateLandsDisplay() {
            document.getElementById('landCount').textContent = lands;
        }

        function changeLands(delta) {
            lands = Math.max(0, lands + delta);
            localStorage.setItem('lands', lands);
            updateLandsDisplay();
        }

        function normalizeTriggers(stored) {
            const defaults = {
                "Archangel of Thune": 0,
                "Case of the Uneaten Feast": 0,
                "Tribute to the World Tree": 0
            };
            const merged = Object.assign({}, defaults, stored || {});
            const normalized = {};
            for (const [name, val] of Object.entries(merged)) {
                normalized[name] = (val && typeof val === 'object') ? (val.count || 0) :
                    (typeof val === 'number' ? val : 0);
            }
            return normalized;
        }

        function save() {
            localStorage.setItem('values', JSON.stringify(values));
            localStorage.setItem('triggers', JSON.stringify(triggers));
            localStorage.setItem('lands', lands);
        }

        function render() {
            const list = document.getElementById('list');
            list.innerHTML = '';

            // Separate creatures by type
            function extractNumber(name) {
                const match = name.match(/\d+/);
                return match ? parseInt(match[0], 10) : 0;
            }

            const insects = Object.entries(values)
                .filter(([k]) => k.startsWith('Insect'))
                .sort((a, b) => extractNumber(b[0]) - extractNumber(a[0])); // newest first

            const scutes = Object.entries(values)
                .filter(([k]) => k.startsWith('Scute'))
                .sort((a, b) => extractNumber(a[0]) - extractNumber(b[0])); // newest first

            // Merge insects first, then scutes
            const sorted = [...insects, ...scutes];

            // Render them
            sorted.forEach(([k, v]) => {
                const div = document.createElement('div');
                div.className = 'item';
                const color = k.startsWith('Scute') ? 'green' : 'black';
                let displayValue;
                if (typeof v === 'object' && v !== null) {
                    // Handle structured creature data
                    const p = v.power ?? 1;
                    const t = v.toughness ?? 1;
                    displayValue = `${p}/${t}`;
                } else {
                    // Handle old numeric values (for backward compatibility)
                    displayValue = v;
                }

                div.innerHTML = `
  <span style="color:${color};"><strong>${k}</strong>: <br>${displayValue}</span>
  <span><button onclick="removeKey('${k}')">‚ùå</button></span>`;
                list.appendChild(div);
            });

            renderTriggers();
            updateLandsDisplay();
            updateCreatureSummary();
        }


        function renderTriggers() {
            const wrap = document.getElementById('triggers');
            wrap.innerHTML = '';
            Object.entries(triggers).forEach(([name, count]) => {
                const div = document.createElement('div');
                div.className = 'trigger';
                div.innerHTML = `
          <span>${name}</span>
          <div class="counter">
            <button onclick="changeCount('${name}', -1)">&#8595;</button>
            <span>${count}</span>
            <button onclick="changeCount('${name}', 1)">&#8593;</button>
          </div>
        `;
                wrap.appendChild(div);
            });
        }

        function changeCount(name, delta) {
            triggers[name] = Math.max(0, (triggers[name] || 0) + delta);
            save();
            renderTriggers();
        }

        function getNextName(base) {
            const existing = Object.keys(values).filter(k => k.startsWith(base)).length;
            return `${base} ${existing + 1}`;
        }

        function createCreature(type) {
            const tribute = triggers["Tribute to the World Tree"] || 0;
            const stat = 1 + tribute;
            const key = getNextName(type);
            values[key] = { power: stat, toughness: stat };
        }

        function buffAllCreatures(multiplier) {
            for (const key in values) {
                values[key].power += multiplier;
                values[key].toughness += multiplier;
            }
        }

        function showPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.style.opacity = 0;
                setTimeout(() => popup.remove(), 500);
            }, 2000);
        }

        function handleLandfall() {
            changeLands(1);

            const scuteKeys = Object.keys(values).filter(k => k.startsWith("Scute"));
            const scuteCount = scuteKeys.length;
            if (scuteCount === 0) return;

            const archangelVal = triggers["Archangel of Thune"] || 0;
            const caseVal = triggers["Case of the Uneaten Feast"] || 0;
            let created = 0;

            const totalToCreate = lands < 6 ? scuteCount : scuteCount; // same number, but type differs
            const typeToCreate = lands < 6 ? "Insect" : "Scute";

            for (let i = 0; i < totalToCreate; i++) {
                createCreature(typeToCreate);
                created++;
                if (archangelVal > 0 && caseVal > 0) {
                    buffAllCreatures(caseVal * archangelVal);
                }
            }

            if (caseVal > 0 && created > 0) {
                const totalLife = created * caseVal;
                showPopup(`You gain ${totalLife} life`);
            }

            save();
            render();
        }

        function removeKey(key) {
            delete values[key];
            save();
            render();
        }

        function removeAll() {
            if (confirm("Remove all existing creatures?")) {
                values = {};
                save();
                render();
            }
        }

        function promptAdd(type) {
            let amount = prompt(`How many ${type === 'Scute' ? 'Scutes' : 'Insect Tokens'} would you like to add?`, "1");
            if (amount === null) return; // user canceled
            amount = parseInt(amount, 10);
            if (isNaN(amount) || amount <= 0) return;
            for (let i = 0; i < amount; i++) createCreature(type);
            save();
            render();
        }

        function resetAll() {
            if (confirm("Reset everything? This will clear creatures and triggers, and reset lands to 3.")) {
                values = {};

                // Reset triggers
                for (const key in triggers) {
                    triggers[key] = 0;
                }

                // Reset lands
                lands = 3;

                save();
                render();
            }
        }


        function updateAddButton() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const addBtn = document.getElementById('addButton');
            if (type === "Insect") {
                addBtn.textContent = "Add Insects";
            } else {
                addBtn.textContent = "Add Scutes";
            }
        }

        function addCounters() {
            if (!confirm("Are you sure you want to give every creature +1/+1?")) return;
            let modified = false;

            Object.keys(values).forEach(k => {
                const creature = values[k];
                if (typeof creature === 'object' && creature !== null) {
                    creature.power = (creature.power ?? 1) + 1;
                    creature.toughness = (creature.toughness ?? 1) + 1;
                    modified = true;
                }
            });

            if (modified) {
                save();
                render();
            }
        }

        function removeCounters() {
            if (!confirm("Are you sure you want to remove 1/1 from every creature?")) return;

            const toDelete = [];

            Object.keys(values).forEach(k => {
                const creature = values[k];
                if (typeof creature === "object" && creature !== null) {
                    creature.power = (creature.power ?? 1) - 1;
                    creature.toughness = (creature.toughness ?? 1) - 1;

                    // mark for deletion if toughness ‚â§ 0
                    if (creature.toughness <= 0) {
                        toDelete.push(k);
                    }
                }
            });

            // remove any that died
            toDelete.forEach(k => delete values[k]);

            if (toDelete.length > 0 || Object.keys(values).length > 0) {
                save();
                render();
            }
        }

        function updateCreatureSummary() {
            const entries = Object.entries(values);

            const totalScutes = entries.filter(([k]) => k.startsWith('Scute')).length;
            const totalInsects = entries.filter(([k]) => k.startsWith('Insect')).length;

            // Sum power/toughness
            let totalPower = 0;
            let totalToughness = 0;
            entries.forEach(([_, v]) => {
                if (typeof v === 'object' && v !== null) {
                    totalPower += v.power ?? 0;
                    totalToughness += v.toughness ?? 0;
                } else if (typeof v === 'number') {
                    totalPower += v;
                    totalToughness += v;
                }
            });

            const summary = document.getElementById('creatureSummary');

            // üß≠ Hide summary entirely if there are no creatures
            if (totalScutes + totalInsects === 0) {
                summary.innerHTML = '';
                return;
            }

            // ü™≤üê¢ Otherwise show counts and totals
            summary.innerHTML = `
    <div>
      <span style="color:green;">${totalScutes.toLocaleString()}</span>
      <span style="color:black;">${totalInsects.toLocaleString()}</span>
    </div>
    <div style="margin-top:0.4em;">
      ${totalPower.toLocaleString()}/${totalToughness.toLocaleString()}
    </div>
  `;
        }



        save();
        render();
        updateAddButton();
    </script>
</body>

</html>